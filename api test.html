<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste API Key Anthropic - GitHub Version</title>
    <style>
        /* Mesmo CSS do anterior, mantido para brevidade */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); padding: 40px; width: 100%; max-width: 500px; }
        h1 { color: #333; margin-bottom: 10px; font-size: 28px; }
        .subtitle { color: #666; margin-bottom: 30px; font-size: 14px; }
        .api-input { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 600; }
        input { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; transition: all 0.3s; }
        input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .toggle-btn { background: none; border: none; color: #667eea; cursor: pointer; font-size: 14px; margin-top: 5px; float: right; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 16px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin: 10px 0; transition: transform 0.2s, box-shadow 0.2s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: #f1f3f9; color: #667eea; }
        .status { margin-top: 25px; padding: 20px; border-radius: 10px; display: none; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }
        .status.loading { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; display: block; }
        .status h3 { margin-bottom: 10px; font-size: 18px; }
        .note { background: #f8f9fa; border-left: 4px solid #667eea; padding: 15px; margin-top: 25px; border-radius: 0 8px 8px 0; font-size: 13px; color: #666; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .proxy-select { margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; }
        .proxy-select select { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîë Teste API Key (GitHub)</h1>
        <p class="subtitle">Vers√£o otimizada para GitHub Pages</p>
        
        <div class="proxy-select">
            <label for="proxySelect">Proxy CORS:</label>
            <select id="proxySelect">
                <option value="corsproxy.io">corsproxy.io (Recomendado)</option>
                <option value="thingproxy.freeboard.io">thingproxy.freeboard.io</option>
                <option value="api.allorigins.win">allorigins.win</option>
                <option value="none">Sem Proxy (localhost apenas)</option>
            </select>
            <p style="font-size: 12px; color: #666; margin-top: 5px;">
                Proxy necess√°rio devido a restri√ß√µes do GitHub Pages
            </p>
        </div>
        
        <div class="api-input">
            <label for="apiKey">Sua API Key:</label>
            <input 
                type="password" 
                id="apiKey" 
                placeholder="sk-ant-..." 
                value=""
            >
            <button class="toggle-btn" onclick="toggleVisibility()">
                üëÅÔ∏è Mostrar
            </button>
        </div>
        
        <button class="btn" onclick="testApiKey()" id="testBtn">
            üß™ Testar API Key
        </button>
        
        <button class="btn btn-secondary" onclick="clearApiKey()">
            üóëÔ∏è Limpar
        </button>
        
        <div id="status" class="status"></div>
        
        <div class="note">
            <strong>‚ö†Ô∏è Aten√ß√£o GitHub Users:</strong> O GitHub Pages bloqueia requisi√ß√µes diretas √† API.<br>
            Este teste usa um proxy CORS p√∫blico para contornar a restri√ß√£o.
        </div>
    </div>

    <script>
        let showKey = false;
        
        // Carrega API Key salva
        window.addEventListener('load', () => {
            const savedKey = localStorage.getItem('test_anthropic_key_github');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
            }
        });
        
        function toggleVisibility() {
            showKey = !showKey;
            const input = document.getElementById('apiKey');
            input.type = showKey ? 'text' : 'password';
            document.querySelector('.toggle-btn').textContent = showKey ? 'üôà Ocultar' : 'üëÅÔ∏è Mostrar';
        }
        
        function getProxyUrl(apiUrl) {
            const proxyType = document.getElementById('proxySelect').value;
            
            switch(proxyType) {
                case 'corsproxy.io':
                    return `https://corsproxy.io/?${encodeURIComponent(apiUrl)}`;
                case 'thingproxy.freeboard.io':
                    return `https://thingproxy.freeboard.io/fetch/${apiUrl}`;
                case 'api.allorigins.win':
                    return `https://api.allorigins.win/raw?url=${encodeURIComponent(apiUrl)}`;
                case 'none':
                default:
                    return apiUrl; // Sem proxy
            }
        }
        
        async function testApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const status = document.getElementById('status');
            const testBtn = document.getElementById('testBtn');
            
            if (!apiKey) {
                status.className = 'status error';
                status.innerHTML = '<h3>‚ùå Erro</h3><p>Por favor, insira uma API Key</p>';
                return;
            }
            
            // Salvar no localStorage
            localStorage.setItem('test_anthropic_key_github', apiKey);
            
            // Verificar formato
            if (!apiKey.startsWith('sk-ant-')) {
                status.className = 'status error';
                status.innerHTML = '<h3>‚ùå Formato Inv√°lido</h3><p>A API Key deve come√ßar com "sk-ant-"</p>';
                return;
            }
            
            // Mostrar loading
            status.className = 'status loading';
            status.innerHTML = '<h3><div class="spinner"></div> Testando conex√£o...</h3><p>Usando proxy CORS para GitHub...</p>';
            testBtn.disabled = true;
            testBtn.innerHTML = '‚è≥ Testando...';
            
            try {
                const startTime = Date.now();
                
                // URL da API da Anthropic
                const apiUrl = 'https://api.anthropic.com/v1/messages';
                
                // Obter URL com proxy para GitHub Pages
                const urlWithProxy = getProxyUrl(apiUrl);
                
                console.log('Usando URL:', urlWithProxy);
                
                const response = await fetch(urlWithProxy, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-api-key": apiKey,
                        "anthropic-version": "2023-06-01",
                        "X-Requested-With": "XMLHttpRequest"
                    },
                    body: JSON.stringify({
                        model: "claude-3-haiku-20240307",
                        max_tokens: 5,
                        messages: [{ 
                            role: "user", 
                            content: "Responda apenas com 'OK'" 
                        }]
                    })
                });
                
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                if (response.ok) {
                    const data = await response.json();
                    
                    status.className = 'status success';
                    status.innerHTML = `
                        <h3>‚úÖ API Key Funcionando!</h3>
                        <p><strong>Status:</strong> Sucesso via Proxy</p>
                        <p><strong>Modelo:</strong> ${data.model || 'N/A'}</p>
                        <p><strong>Tempo:</strong> ${responseTime}ms</p>
                        <p><strong>Proxy usado:</strong> ${document.getElementById('proxySelect').value}</p>
                        <p>Sua API Key est√° configurada corretamente!</p>
                    `;
                    
                } else {
                    const errorText = await response.text();
                    
                    let errorMessage = '';
                    
                    switch (response.status) {
                        case 401:
                            errorMessage = 'API Key inv√°lida ou expirada';
                            break;
                        case 403:
                            errorMessage = 'Sem permiss√µes ou cota excedida';
                            break;
                        case 429:
                            errorMessage = 'Limite de requisi√ß√µes excedido';
                            break;
                        default:
                            errorMessage = `Erro ${response.status}`;
                    }
                    
                    status.className = 'status error';
                    status.innerHTML = `
                        <h3>‚ùå Erro na API</h3>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Erro:</strong> ${errorMessage}</p>
                        <p>Tente outro proxy ou verifique sua API Key.</p>
                    `;
                }
                
            } catch (error) {
                console.error('Erro completo:', error);
                
                status.className = 'status error';
                status.innerHTML = `
                    <h3>‚ùå Erro de Conex√£o</h3>
                    <p><strong>Detalhes:</strong> ${error.message}</p>
                    <p><strong>Solu√ß√µes:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Tente outro proxy na lista acima</li>
                        <li>O proxy pode estar temporariamente indispon√≠vel</li>
                        <li>Teste localmente sem proxy</li>
                        <li>Verifique se sua API Key est√° ativa</li>
                    </ul>
                    <p style="margin-top: 15px; font-size: 14px;">
                        <strong>Proxy atual:</strong> ${document.getElementById('proxySelect').value}
                    </p>
                `;
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = 'üß™ Testar API Key';
            }
        }
        
        function clearApiKey() {
            document.getElementById('apiKey').value = '';
            localStorage.removeItem('test_anthropic_key_github');
            document.getElementById('status').className = 'status';
            document.getElementById('status').innerHTML = '';
            
            showKey = false;
            document.getElementById('apiKey').type = 'password';
            document.querySelector('.toggle-btn').textContent = 'üëÅÔ∏è Mostrar';
        }
        
        // Teste inicial do proxy
        console.log('Testador de API Key para GitHub Pages carregado');
        console.log('Proxies dispon√≠veis: corsproxy.io, thingproxy.freeboard.io, api.allorigins.win');
    </script>
</body>
</html>
